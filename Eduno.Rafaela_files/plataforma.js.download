const hot_regex_cnpj = /^\d{2}\.\d{3}\.\d{3}\/\d{4}\-\d{2}$/;
const hot_regex_cpf = /^\d{3}\.\d{3}\.\d{3}\-\d{2}$/;
const hot_regex_email = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
const hot_regex_celular = /^\d{2}\-\d{5}\-\d{4}$/;
const hot_regex_cep = /^\d{5}\-\d{3}$/;
const hot_regex_moeda = /^[0-9]*[\,\.][0-9]{2}$/;
const hot_regex_percentual = /^[0-9]*[\,\.][0-9]{2}$/;
const hot_regex_inteiro = /^[0-9]*$/;
const hot_regex_url = /^(https?:\/\/)?([\w-]+(\.[\w-]+)+)(:\d+)?(\/[\w\-._~:/?#[\]@!$&'()*+,;=%]*)?$/i;

var w_transacao = {"emandamento": false};

$(document).ready(function () {
	
	$.ajaxSetup({
		headers: {
			'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
		}
	});
	
	$(document).ajaxStart(function () {
		$('#ed-processando-solicitacao').fadeIn(); 
		w_transacao.emandamento = true;
		fnc_fundacao_ligaAcessandoServidor();		
	});

	$(document).ajaxStop(function () { 
		$('#ed-processando-solicitacao').fadeOut(); 
		w_transacao.emandamento = false;
        fnc_fundacao_desligaAcessandoServidor();		
	});	
			
	$('ul.hot-perfis li').click(function () {
		fnc_fundacao_mudaperfil_processa($(this));
	});
	
	$('.hot-menu button.hot-submenu').click(function () {
		$('.hot-menu button.hot-submenu').removeClass('active');
		$(this).addClass('active');
	});
	
	$('header#hot-header .exibemenu').click(function () {
		$('body').toggleClass('sidebar-open');
	});
	
	$('.hot_relatorio_fechar').click(function () {
		$('#hot_relatorio').fadeOut();
	});
	
	$('#hot_sobreposto_fechar').click(function () {
		$('#hot_sobreposto').fadeOut();
		$('#hot_sobreposto_conteudo').empty();
	});
		
	setInterval(function () { fnc_fundacao_alerta_suspensao(); }, 10000);
});

function fnc_fundacao_ligaAcessandoServidor() {
	return $('#acessandoServidor').show();
}

function fnc_fundacao_desligaAcessandoServidor() {
	return $('#acessandoServidor, .acessandoServidor').hide();
}

function fnc_fundacao_verificaAcessandoServidor() {
	
	if (fnc_fundacao_estaAcessandoServidor()) {
		return true;
	}
	
	fnc_fundacao_ligaAcessandoServidor();
	
	return false;
}

function fnc_fundacao_estaAcessandoServidor() {
	return $('#acessandoServidor').is(":visible");
}

function fnc_fundacao_exibeErroModal(p_mensagem) {

	var w_erroModal = new bootstrap.Modal($('#erroModal')[0], {keyboard: false});
	
	$('#erroModalMensagem').html(p_mensagem);
	
	fnc_fundacao_desligaAcessandoServidor();
	
	$('#indicador-gerandoRelatorio').hide();
	$('.acessandoServidor-relatorio').hide();
	
	w_erroModal.show();	
}

function fnc_fundacao_obtemExtensao(file) {
    return (/[.]/.exec(file)) ? /[^.]+$/.exec(file.toLowerCase()) : '';
}

function fnc_temAlgumErroNosCampos(p_regras) {
	
	$('.is-invalid').removeClass('is-invalid');
	
	p_regras.forEach(function (p_regra) {
				
		if (p_regra.valor !== undefined) {
			return;
		}
		
		if ($('#' + p_regra.id).length === 0) {
			return;
		}		
		
		if ((p_regra.imagem !== undefined && p_regra.imagem)
			|| (p_regra.pdf !== undefined && p_regra.pdf)
			|| (p_regra.imagemoupdf !== undefined && p_regra.imagemoupdf)
			|| (p_regra.arquivo !== undefined && p_regra.arquivo)) {
		
			var w_arquivos = $('#' + p_regra.id)[0].files;
			
			if (w_arquivos.length === 0) {

				if (p_regra.opcional === undefined || p_regra.opcional === false) {
					
					$('#' + p_regra.id).addClass('is-invalid');
					
					return;
				}
				
				return;				
			}
			
			if (p_regra.arquivo !== undefined && p_regra.arquivo) {
				return;
			}
			
			var w_extensao = fnc_fundacao_obtemExtensao(w_arquivos[0].name);
			var w_erro = false;
			
			if (p_regra.imagem !== undefined && p_regra.imagem && !(w_extensao && /^(png|jpeg|jpg|gif)$/.test(w_extensao))) {
				w_erro = true;
			} else if (p_regra.imagemoupdf !== undefined && p_regra.imagemoupdf && !(w_extensao && /^(pdf|png|jpeg|jpg|gif)$/.test(w_extensao))) {
				w_erro = true;
			} else if (p_regra.pdf !== undefined && p_regra.pdf && !(w_extensao && /^(pdf)$/.test(w_extensao))) {
				w_erro = true;
			}
			
			if (w_erro) {
				
				$('#' + p_regra.id).addClass('is-invalid');
				return;
			}
				
			return;			
		}
		
		if ($('#' + p_regra.id).val() === null || $('#' + p_regra.id).val().length === 0) {
			
			if (p_regra.opcional === undefined || p_regra.opcional === false) {
				$('#' + p_regra.id).addClass('is-invalid');
				return;
			}
			
			return;
		}
					
		if (p_regra.minimo !== undefined && $('#' + p_regra.id).val().length < p_regra.minimo) {
			$('#' + p_regra.id).addClass('is-invalid');
		}
		
		if (p_regra.maximo !== undefined && $('#' + p_regra.id).val().length > p_regra.maximo) {
			$('#' + p_regra.id).addClass('is-invalid');
		}		
		
		if (p_regra.tamanho !== undefined && $('#' + p_regra.id).val().length != p_regra.tamanho) {
			$('#' + p_regra.id).addClass('is-invalid');
		}
		
		if (p_regra.formato !== undefined && ! p_regra.formato.test($('#' + p_regra.id).val())) {
			$('#' + p_regra.id).addClass('is-invalid');
		}
		
		if (p_regra.function !== undefined && ! p_regra.function($('#' + p_regra.id).val())) {
			$('#' + p_regra.id).addClass('is-invalid');
		}		
	});
	
	return $('.is-invalid').length !== 0;
	
}

function fnc_verificaSeCPFValido(p_cpf) {

    var i = 0;

    if (p_cpf.length === 0 || !hot_regex_cpf.test(p_cpf)) {
        return false;
    }

    var c = p_cpf.substr(0, 3) + p_cpf.substr(4, 3) + p_cpf.substr(8, 3);
    var dv = p_cpf.substr(12, 2);

    var d1 = 0;

    for (i = 0; i < 9; i++) {
        d1 += c.charAt(i) * (10 - i);
    }
    if (d1 == 0) {
        return false;
    }
    d1 = 11 - (d1 % 11);
    if (d1 > 9)
        d1 = 0;
    if (dv.charAt(0) != d1) {
        return false;
    }
    d1 *= 2;
    for (i = 0; i < 9; i++) {
        d1 += c.charAt(i) * (11 - i);
    }
    d1 = 11 - (d1 % 11);
    if (d1 > 9)
        d1 = 0;
    if (dv.charAt(1) != d1) {
        return false;
    }

    return true;
}

function fnc_fundacao_verificaSeDataValida(dtStr) {

    var dtCh = "-";
    var minYear = 1500;
    var maxYear = 2167;

    var daysInMonth = [0, 31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    var pos1 = dtStr.indexOf(dtCh);
    var pos2 = dtStr.indexOf(dtCh, pos1 + 1);

    if (pos1 === -1 || pos2 === -1) {
        return false;
    }

    var strDay = dtStr.substring(0, pos1);
    var strMonth = dtStr.substring(pos1 + 1, pos2);
    var strYear = dtStr.substring(pos2 + 1);

    var strYr = strYear;

    if (strDay.charAt(0) === "0" && strDay.length > 1)
        strDay = strDay.substring(1);
    if (strMonth.charAt(0) === "0" && strMonth.length > 1)
        strMonth = strMonth.substring(1);
    for (var i = 1; i <= 3; i++) {
        if (strYr.charAt(0) === "0" && strYr.length > 1)
            strYr = strYr.substring(1);
    }

    var month = parseInt(strMonth);
    var day = parseInt(strDay);
    var year = parseInt(strYr);

    if (strMonth.length < 1 || month < 1 || month > 12) {
        return false;
    }

    if (strDay.length < 1
            || day < 1
            || day > 31
            || (month === 2
                    && day > daysInFebruary(year))
            || day > daysInMonth[month]) {
        return false;
    }

    if (strYear.length != 4 || year == 0 || year < minYear || year > maxYear) {
        return false;;
    }

    if (dtStr.indexOf(dtCh, pos2 + 1) != -1 || !hot_regex_inteiro.test(stripCharsInBag(dtStr, dtCh))) {
        return false;
    }

    return true;
}

function stripCharsInBag(s, bag) {
    var i;
    var returnString = "";
    // Search through string's characters one by one.
    // If character is not in bag, append to returnString.
    for (i = 0; i < s.length; i++) {
        var c = s.charAt(i);
        if (bag.indexOf(c) === -1)
            returnString += c;
    }
    return returnString;
}

function daysInFebruary(year) {
    // February has 29 days in any year evenly divisible by four,
    // EXCEPT for centurial years which are not also divisible by 400.
    return (((year % 4 === 0) && ((!(year % 100 === 0)) || (year % 400 === 0))) ? 29 : 28);
}

function DaysArray(n) {
    for (var i = 1; i <= n; i++) {
        this[i] = 31;
        if (i === 4 || i === 6 || i === 9 || i === 11) {
            this[i] = 30;
        }
        if (i === 2) {
            this[i] = 29;
        }
    }
    return this;
}

function fnc_fundacao_campoFormatoValor(p_objeto) {
	
	p_objeto.on('keypress keyup blur', function(e) {
		
		var w_numero_decimais = $(this).attr('data-numdec') === undefined ? 2 : parseInt($(this).attr('data-numdec'));
		
		var w_valor = 0 + $(this).val().replace(/[^0-9]/g,'');
		var w_float = parseFloat(w_valor) / Math.pow(10, w_numero_decimais);
		

		$(this).val(w_float.toFixed(w_numero_decimais).replace('.', ','));
	});
}

function fnc_habilita_campo_valor() {
	
	$('.hot-valor').each(function() {
		fnc_fundacao_campoFormatoValor($(this));
	});
	
	$('.hot-numerico').on('keypress keyup blur', function(e) {

		var w_valor = $(this).val().replace(/[^0-9]/g,'');
		$(this).val(w_valor);
	});
	
    $('.hsyDatePicker').each(function () {
		
		var options = {
			format: 'dd-mm-yyyy', // Formato de data brasileiro
			maxViewMode: 2, // Visualização restrita a dias, meses e anos
			language: "pt-BR", // Linguagem PT-BR
			daysOfWeekHighlighted: "0,6", // Marcar os dias do final de semana
			calendarWeeks: true, // Mostrar as semanas no calendário
			todayHighlight: true, // Marcar o dia atual
			orientation: "auto", //
			autoclose: true, // Fechar automaticamente ao selecionar data
			container:'#hot-approom'
		};
		
		$(this).datepicker(options);
	});
	
    $('.hsyMonthPicker').each(function () {
		
		var optionsMP = {
			format: 'M-yyyy', // Formato de data brasileiro
			language: "pt-BR", // Linguagem PT-BR
			autoclose: true // Fechar automaticamente ao selecionar data
		};
		
		$(this).datepicker(optionsMP);
	});

    $('.hsyMask').each(function () {

        switch ($(this).attr('hsyMask')) {

            // https://igorescobar.github.io/jQuery-Mask-Plugin/docs.html

			case 'data':
                $(this).mask('00-00-0000');
                break;
            case 'cep':
                $(this).mask('00000-000');
                break;
            case 'cpf':
                $(this).mask('000.000.000-00');
                break;
            case 'cnpj':
                $(this).mask('00.000.000/0000-00');
                break;
            case 'telefonefixo':
                $(this).mask('00-0000-0000');
                break;
            case 'telefonecelular':
                $(this).mask('00-00000-0000');
                break;
            case 'telefone':
                var options = {
                    onKeyPress: function (tel, e, field, options) {
                        var masks = ['(00) 0000-00009', '(00) 00000-0000'];
                        var mask = (tel.length > 14) ? masks[1] : masks[0];
                        $('.telefone').mask(mask, options);
                    }, placeholder: "(__) _____-____"};
                $(this).mask('(00) 0000-00009', options);
                break;
            default:
                $(this).mask($(this).attr('hsyMask'));
                break;
        }
    });

    $('[data-toggle="tooltip"]').tooltip();

    $('[hsyMask="cep"]').blur(function () {

        var cep = $(this).val().replace(/\D/g, '');

        if (cep.length !== 0) {

            var validacep = /^[0-9]{8}$/;

            if (validacep.test(cep)) {
				
				alert('implementar chamada aqui');
            }
        }
    });
	
	$('.hot-dependencia').change(function () {
		
		var w_campos = $(this).find(":selected").attr('data-dependencia').split(',');
		
		w_campos.forEach(function (p_elemento) {
			if (p_elemento.length >= 2) {
				$(`#d_${p_elemento.substring(1)}`).toggle(p_elemento.substring(0, 1) === '+');
				$(`#${p_elemento.substring(1)}`).removeClass('is-invalid');
			}
		});
	});
	
	$('.hot-dependencia').change();
	
	$('.ed-check-selecionar-tudo').change(function () {
		$(this).closest('table').find('.form-check-input').prop('checked', $(this).is(':checked'));
	});
	
	$('.hot-semquebralinha').keydown(function (e) {
		if(e.keyCode === 13) { e.preventDefault(); }
	});
}

var w_sessao = {};

function fnc_inicia_acesso_ao_servidor(p_botao) {
	
	if (p_botao.attr('data-salvando') !== undefined) {	
		return false;
	}
	
	w_sessao.botaosalvar = p_botao;
	
	p_botao.attr('data-salvando', 'S');
	
	$('#salvando').show();
	$('#erro').hide();	
	
	return true;
}

function fnc_encerra_acesso_ao_servidor(p_mensagem) {
	
	w_sessao.botaosalvar.removeAttr('data-salvando');
	
	$('#salvando').hide();
	$('#erro').html(p_mensagem).show();	
}

function fnc_fundacao_transportavalores(p_array, p_objeto) {

	p_array.forEach(function (p_regra) {
		
		if (p_regra.nomebd !== undefined && p_objeto[p_regra.nomebd] !== undefined) {
		
			if ($('#' + p_regra.id).hasClass('hsyDatePicker')) {
				$('#' + p_regra.id).datepicker('setDate', p_objeto[p_regra.nomebd]);
			} else {
				$('#' + p_regra.id).val(p_objeto[p_regra.nomebd]);
			}
		}
	});
}

function fnc_fundacao_limpavalores(p_array) {

	p_array.forEach(function (p_regra) {
		$('#' + p_regra.id).val('');
	});
}

function fnc_fundacao_scrollToAnchor(aid, p_deslocamento){
	
    var aTag = $("a[name='"+ aid +"']");
	
    $('html,body').animate({scrollTop: aTag.offset().top - (p_deslocamento === undefined ? 0 : p_deslocamento)},'slow');
}

function fnc_fundacao_validaCampo(p_campo, p_regra) {
	
	p_campo.removeClass('is-invalid');
	
	if (!p_regra) {	
	
		p_campo.addClass('is-invalid');
		
		return 1;
	}
	
	return 0;
}

function fnc_fundacao_enviaTelaParaServidor(p_url, p_campos, p_sucesso_funcao, p_sucesso_url, p_erro_funcao) {
	
	if (w_transacao.emandamento) return;

	var formData = new FormData();
	
	p_campos.forEach(function (p_elemento) {
					
		if (p_elemento.valor !== undefined) {
			if (Array.isArray(p_elemento.valor)) {
				p_elemento.valor.forEach(function (p_item) {
					formData.append(`${p_elemento.nomebd === undefined ? p_elemento.id : p_elemento.nomebd}[]`, p_item);
				});
			} else if (p_elemento.valor instanceof File) {
				formData.append(p_elemento.nomebd === undefined ? p_elemento.id : p_elemento.nomebd,
					p_elemento.valor,
					p_elemento.valor.name);
			} else {
				formData.append(p_elemento.nomebd === undefined ? p_elemento.id : p_elemento.nomebd, p_elemento.valor);
			}
		} else if ($(`#${p_elemento.id}`).length == 0) {
			// Se zero, significa que o campo não existe; nada faz
		} else if (p_elemento.formato !== undefined 
			&& (p_elemento.formato === hot_regex_moeda
				|| p_elemento.formato === hot_regex_percentual)) {
			formData.append(p_elemento.nomebd === undefined ? p_elemento.id : p_elemento.nomebd, $(`#${p_elemento.id}`).val().replace(',','.'));
		} else if ((p_elemento.imagem !== undefined && p_elemento.imagem) || (p_elemento.imagemoupdf !== undefined && p_elemento.imagemoupdf) || (p_elemento.pdf !== undefined && p_elemento.pdf) || (p_elemento.arquivo !== undefined && p_elemento.arquivo)) {
			
			var w_files = $(`#${p_elemento.id}`)[0].files;
	
			if (w_files.length) {
		
				var w_file = w_files[0];
				var w_extensao = fnc_fundacao_obtemExtensao(w_file.name);	

				formData.append(p_elemento.nomebd === undefined ? p_elemento.id : p_elemento.nomebd,
					w_file,
					w_file.name);
			}
		} else {
			formData.append(p_elemento.nomebd === undefined ? p_elemento.id : p_elemento.nomebd, $(`#${p_elemento.id}`).val());
		}
	});
		
	$.ajax({
		url: p_url,
		type: 'POST',
		data: formData,
		contentType: false,
		processData: false,
		success: function (w_obj) {
			
			switch (w_obj.rc) {
			
				case '00':
				
					p_sucesso_funcao(p_sucesso_url, w_obj);
					break;
			
				default:
			
					p_erro_funcao(w_obj.msg);
			}
		},
		error: function (jqXHR, textStatus, errorThrown) {

			var w_mensagem = '<div class="alert alert-light mb-3"><strong>Ocorreu um erro inesperado; tente mais tarde!</strong></div><div class="alert alert-light">';
			if (jqXHR.status === 0 && textStatus === 'error') {
				w_mensagem += `<div class="f-7">Ação</div><div><strong>Verifique sua conexão com a Internet; aparentemente está instável.</strong></div>`;
			}			
			w_mensagem += `<div class="f-7">Código</div><div><strong>${jqXHR.status} (${jqXHR.statusText})</strong></div>`;
			w_mensagem += `<div class="f-7">Tipo</div><div><strong>${textStatus}</strong></div>`;
			w_mensagem += `<div class="f-7">Detalhe</div><div><strong>${errorThrown}</strong></div>`;
			w_mensagem += `</div>`;
			p_erro_funcao(w_mensagem);
		}
	});	
}

function fnc_fundacao_obtemTelaDoServidor(p_url, p_sucesso_funcao, p_erro_funcao) {

	$.ajax({
		url: p_url,
		type: 'GET',
		contentType: false,
		processData: false,
		success: function (w_retorno) {
			p_sucesso_funcao(w_retorno);
		},
		error: function () {
			p_erro_funcao('Ocorreu um erro inesperado; tente mais tarde!');
		}
	});
}

function fnc_fundacao_reload() {
	location.reload();
}

function fnc_fundacao_direciona(p_url) {
	location.href = p_url;
}

function fnc_fundacao_direcionaComID(p_url, p_retorno) {
	location.href = p_url + '/' + p_retorno.id;
}

function fnc_confere_valor_curso(p_valor){
	
	if($("#newval").val()==""  &&  $("#newval2").val()==""){
		return false;
	}
	else if($("#newval").val()==""  &&  $("#newval2").val()!=""){
		return true;
	}
	else if($("#newval").val()!=""){
		
		if(p_valor.length === 0 || !hot_regex_moeda.test(p_valor)){
			return false;
		}
	}
	return true;
}

function fnc_confere_valor_matri(p_valor){
	
	if($("#newval").val()==""  &&  $("#newval2").val()==""){
		return false;
	}
	else if( $("#newval2").val()=="" &&  $("#newval").val()!=""){
		return true;		
	}
	else if($("#newval2").val()!=""){
		if(p_valor.length === 0 || !hot_regex_moeda.test(p_valor)){
			return false;
		}
	}
	
	return true;
}

function fnc_confere_options_curso(){
	
const ids = [];
var check =document.getElementsByName("agree"); 
 for (var i = 0; i < check.length; i++) {
	if (check[i].checked) {
		ids.push(check[i].value);
	}
}	
	if(ids.length<1){
		return false;
	}
	return true;
}

function fnc_fundacao_mudaperfil() {
	
    var w_canvas = new bootstrap.Offcanvas($('#offcanvasPerfil')[0]);
    w_canvas.show()
}

function fnc_fundacao_mudaperfil_processa(p_objeto) {
	
	var w_array = [];	

	w_array.push({ "id": "perfil", "valor": p_objeto.attr('data-perfil') });
			
	fnc_fundacao_enviaTelaParaServidor('/apiMudaPerfilUsuario', 
		w_array, 
		function() { location.href = '/inicio' }, 
		'', 
		function() { });
}

function fnc_fundacao_keyup_delay(callback, ms, p_objeto) {
	
    var timer = 0;
	
    return function () {
		
        var context = this, args = arguments;
		
        clearTimeout(timer);
		
        timer = setTimeout(function () {
            callback.apply(context, args);
        }, ms || 0);
    };
}

function fnc_verificaSeCNPJValido(p_cnpj) {

   var cnpj = p_cnpj;
        var valida = new Array(6,5,4,3,2,9,8,7,6,5,4,3,2);
        var dig1= new Number;
        var dig2= new Number;

        exp = /\.|\-|\//g
        cnpj = cnpj.toString().replace( exp, "" ); 
        var digito = new Number(eval(cnpj.charAt(12)+cnpj.charAt(13)));

        for(i = 0; i<valida.length; i++){
                dig1 += (i>0? (cnpj.charAt(i-1)*valida[i]):0);  
                dig2 += cnpj.charAt(i)*valida[i];       
        }
        dig1 = (((dig1%11)<2)? 0:(11-(dig1%11)));
        dig2 = (((dig2%11)<2)? 0:(11-(dig2%11)));

        if(((dig1*10)+dig2) != digito)  
               return false;

    return true;
}

function fnc_verificaSeCPFouCNPJValido(p_cpfcnpj) {
	
	return p_cpfcnpj.length === 14
		? fnc_verificaSeCPFValido(p_cpfcnpj)
		: (p_cpfcnpj.length === 18
			? fnc_verificaSeCNPJValido(p_cpfcnpj)
			: false);
}

function fnc_fundacao_geraParmData() {

    var data = new Date();
    var mes = parseInt(data.getMonth()) + 1;

    return "dt=" + data.getYear() + mes + data.getDate() + data.getHours() + data.getMinutes() + data.getSeconds() + data.getMilliseconds();
}

function fnc_toaster(p_severidade, p_titulo, p_mensagem, p_tempo) {

    var w_icone = '';

    switch (p_severidade) {

        case 'E':
            w_icone = '<div class="hot-talert hot-talert-vermelho rounded mr-2"><i class="fas fa-exclamation-triangle"></i></div>';
            break;

        case 'I':
            w_icone = '<div class="hot-talert hot-talert-verde rounded mr-2"><i class="fas fa-info-circle"></i></div>';
            break;
    }

    var w_div = $('<div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="' + p_tempo + '"><div class="toast-header">' + w_icone + '&nbsp;<strong class="me-auto">' + p_titulo + '</strong><button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button></div><div class="toast-body">' + p_mensagem + '</div></div>');

    w_div.on('hidden.bs.toast', function () {
        $(this).remove();
    });

    $('#hot-toasts').append(w_div);

    w_div.toast('show');
}

function fnc_fundacao_dimensiona_containers_graficos() {

	$('.hot-grafico').each(function () {
		$(this).height($(this).width() * 0.625);
	});
}

function fnc_fundacao_relatorio_processa(p_relatorio, p_campos) {
	
	$('#indicador-gerandoRelatorio .progress-bar').css('width', '10%');
	$('#indicador-gerandoRelatorio').fadeIn();
	
	fnc_fundacao_enviaTelaParaServidor(`/apiRelatorioIniciaExecucao/${p_relatorio}`, 
		p_campos, 
		fnc_fundacao_relatorio_aguardaexecucao, 
		'', 
		fnc_fundacao_exibeErroModal);
}

function fnc_fundacao_relatorio_processa_job(p_job, p_campos) {
	
	$('#indicador-gerandoRelatorio .progress-bar').css('width', '10%');
	$('#indicador-gerandoRelatorio').fadeIn();
	
	fnc_fundacao_enviaTelaParaServidor(`/apiRelatorioIniciaExecucaoJob/${p_job}`, 
		p_campos, 
		fnc_fundacao_relatorio_aguardaexecucao, 
		'', 
		fnc_fundacao_exibeErroModal);
}

function fnc_fundacao_relatorio_urlespecifica(p_url, p_campos) {
	
	$('#indicador-gerandoRelatorio .progress-bar').css('width', '10%');
	$('#indicador-gerandoRelatorio').fadeIn();
	
	fnc_fundacao_enviaTelaParaServidor(`/${p_url}`, 
		p_campos, 
		fnc_fundacao_relatorio_aguardaexecucao, 
		'', 
		fnc_fundacao_exibeErroModal);
}

function fnc_fundacao_relatorio_aguardaexecucao(p_url, p_retorno) {

	var w_TXT_UUIDX_RELAT = p_retorno.TXT_UUIDX_RELAT;
	var w_user_id = p_retorno.id;
	var w_formato = p_retorno.formato;
	var w_numero_voltas = 0;

	var w_timer = setInterval(function() {
		
		fnc_fundacao_enviaTelaParaServidor(`/apiRelatorioVerificaExecucao/${w_TXT_UUIDX_RELAT}`, 
			[], 
			function (p_url, p_retorno) {

				switch(p_retorno.FLG_STATU_SOLIC) {
				
					case 'F':
						clearInterval(w_timer);
						fnc_fundacao_relatorio_visualizacao(w_user_id, w_TXT_UUIDX_RELAT, w_formato);
						return;
						
					case 'E':

						clearInterval(w_timer);
						fnc_fundacao_exibeErroModal(p_retorno.msg);
						return;
						
					default:
					
						w_numero_voltas++;
				
						if (w_numero_voltas > 150) {
					
							clearInterval(w_timer);
							fnc_fundacao_exibeErroModal('Tempo de execução do relatório excedeu limite programado. Solicite apoio ao suporte técnico.');
							return;
						}

						$('#indicador-gerandoRelatorio .progress-bar').css('width', `${p_retorno.PCT_COMPL_EXECS}%`);
					
						break;
				}				
			}, 
			'', 
			fnc_fundacao_exibeErroModal);		
		
	}, 2000);
}

function fnc_fundacao_job_inicia_processamento(p_apiinicial, p_apiverificacao, p_campos) {
	
	$('#indicador-gerandoRelatorio .progress-bar').css('width', '10%');
	$('#indicador-gerandoRelatorio').fadeIn();
	
	fnc_fundacao_enviaTelaParaServidor(p_apiinicial, 
		p_campos, 
		fnc_fundacao_job_aguarda_processamento, 
		p_apiverificacao, 
		fnc_fundacao_exibeErroModal);
}

function fnc_fundacao_job_aguarda_processamento(p_apiverificacao, p_retorno) {

	var w_numero_voltas = 0;

	var w_timer = setInterval(function() {
		
		fnc_fundacao_enviaTelaParaServidor(p_apiverificacao, 
			p_retorno.campos, 
			function (p_url, p_retorno) {

				switch(p_retorno.status) {
				
					case 'F':
						clearInterval(w_timer);
						$('.acessandoServidor-relatorio').hide();
						fnc_fundacao_arquivo_visualizacao(p_retorno.url);
						return;
						
					case 'E':

						clearInterval(w_timer);
						fnc_fundacao_exibeErroModal(p_retorno.msg);
						return;
						
					default:
					
						w_numero_voltas++;
				
						if (w_numero_voltas > 150) {
					
							clearInterval(w_timer);
							fnc_fundacao_exibeErroModal('Tempo de execução do relatório excedeu limite programado. Solicite apoio ao suporte técnico.');
							return;
						}

						$('#indicador-gerandoRelatorio .progress-bar').css('width', `${p_retorno.PCT_COMPL_EXECS}%`);
					
						break;
				}				
			}, 
			'',
			function (p_msg) {
				
				clearInterval(w_timer);
				fnc_fundacao_exibeErroModal(p_msg);
			} 
			);		
		
	}, 2000);
}

function fnc_fundacao_geraNumeroRelatorio() {

    var data = new Date();
    var mes = parseInt(data.getMonth()) + 1;

    return `${data.getYear()}${mes}${data.getDate()}${data.getHours()}${data.getMinutes()}${data.getSeconds()}${data.getMilliseconds()}`;
}

function fnc_fundacao_relatorio_visualizacao(p_user_id, p_TXT_UUIDX_RELAT, p_formato) {
	
	$('#indicador-gerandoRelatorio .progress-bar').css('width', '100%');
	$('.acessandoServidor-relatorio').hide();
	
	var w_complemento = $('#x_relatorio_complemento').length === 0 ? '' : $('#x_relatorio_complemento').val();
	
	switch (`${p_formato}${w_complemento}`) {
		
		case 'html':
		case 'jpg':
		case 'pdf':
		
			$('#hot_relatorio_conteudo').html($('<iframe>').attr('src', `/storage/relatorios/REL_${p_user_id}_${p_TXT_UUIDX_RELAT}.${p_formato}`));
			$('#hot_relatorio').show();
			break;
			
		case 'pdf_blank':
		
			$('#hot_relatorio_conteudo').html(`<a target="_blank" id="a_arquivo_link" href="/storage/relatorios/REL_${p_user_id}_${p_TXT_UUIDX_RELAT}.${p_formato}">LINK</a>"`);
            $('#a_arquivo_link')[0].click();
			break;
						
		default:
		
            $('#hot_relatorio_conteudo').html(`<a target="_blank" id="a_arquivo_link" href="/storage/relatorios/REL_${p_user_id}_${p_TXT_UUIDX_RELAT}.${p_formato}" download="relatorio${fnc_fundacao_geraNumeroRelatorio()}.${p_formato}">LINK</a>"`);
            $('#a_arquivo_link')[0].click();
		
			break;
	}
	
	$('#indicador-gerandoRelatorio').hide();
	$('.acessandoServidor').hide();
}

function fnc_fundacao_relatorioV2_inicia(p_id, p_relatorio_id, p_parametros) {
		
	$('#hot_relatorio_conteudo').html($('<iframe>').attr('src', `/relatorio/${p_id}/${p_relatorio_id}/${p_parametros}`));
	$('#hot_relatorio').show();
}

function fnc_fundacao_relatorioV3_inicia(p_url) {
		
	$('#hot_relatorio_conteudo').html($('<iframe>').attr('src', p_url));
	$('#hot_relatorio').show();
}

function fnc_fundacao_relatorioV2_aguardaexecucao(p_parametros) {

	var w_TXT_UUIDX_RELAT = p_parametros.TXT_UUIDX_RELAT;
	var w_user_id = p_parametros.id;
	var w_formato = p_parametros.formato;
	var w_numero_voltas = 0;

	var w_timer = setInterval(function() {
		
		fnc_fundacao_enviaTelaParaServidor(`/apiRelatorioVerificaExecucao/${w_TXT_UUIDX_RELAT}`, 
			[], 
			function (p_url, p_retorno) {

				switch(p_retorno.FLG_STATU_SOLIC) {
				
					case 'F':
						clearInterval(w_timer);
						location.href = `/storage/relatorios/REL_${w_user_id}_${w_TXT_UUIDX_RELAT}.pdf`;
						return;
						
					case 'E':

						clearInterval(w_timer);
						location.href = '/relatorio/erro';
						// fnc_fundacao_exibeErroModal(p_retorno.msg);
						return;
						
					default:
					
						w_numero_voltas++;
				
						if (w_numero_voltas > 150) {
					
							clearInterval(w_timer);
							location.href = '/relatorio/erro';
							// fnc_fundacao_exibeErroModal('Tempo de execução do relatório excedeu limite programado. Solicite apoio ao suporte técnico.');
							return;
						}

						$('#indicador-gerandoRelatorio .progress-bar').css('width', `${p_retorno.PCT_COMPL_EXECS}%`);
						$('#indicador-gerandoRelatorio .progress-bar').text(`${p_retorno.PCT_COMPL_EXECS}%`);
					
						break;
				}				
			}, 
			'', 
			fnc_fundacao_exibeErroModal);		
		
	}, 2000);
}

function fnc_fundacao_arquivo_visualizacao(p_arquivo) {

	$('#hot_relatorio_conteudo').html($('<iframe>').attr('src', fnc_fundacao_adiciona_parmdata(p_arquivo)));
	$('#hot_relatorio').show();
	
	$('#indicador-gerandoRelatorio').hide();
	$('.acessandoServidor').hide();	
}

function fnc_fundacao_adiciona_parmdata(p_url) {

	return p_url 
		+ (p_url.indexOf('?') === -1 ? '?' : '&')
		+ fnc_fundacao_geraParmData();
}

function fnc_fundacao_obtem_objeto_tela(p_identificacao_tela, p_secao, p_inicializacao) {

	var w_estado = sessionStorage.getItem(p_identificacao_tela);

	w_estado = w_estado == undefined ? {} : JSON.parse(w_estado);
	
	w_estado[p_secao] = w_estado[p_secao] == undefined ? p_inicializacao : w_estado[p_secao];
	
	return w_estado;
}

function fnc_fundacao_salva_objeto_tela(p_identificacao_tela, p_objeto) {

	sessionStorage.setItem(p_identificacao_tela, JSON.stringify(p_objeto));
}

function fnc_fundacao_posicao_vertical(p_identificacao_tela) {
	
	var w_estado = fnc_fundacao_obtem_objeto_tela(p_identificacao_tela, 'pv', 0);
	
	$(window).scrollTop(w_estado['pv']).scroll(function () {
		var w_estado = fnc_fundacao_obtem_objeto_tela(p_identificacao_tela, 'pv', 0);
		w_estado['pv'] = $(window).scrollTop();
		fnc_fundacao_salva_objeto_tela(p_identificacao_tela, w_estado);
	});		
}

function fnc_fundacao_remove_objeto_tela(p_identificacao_tela) {

	sessionStorage.removeItem(p_identificacao_tela);
}

function fnc_fundacao_arvore_ativa(p_identificacao_tela) {

/* 	var toggler = document.getElementsByClassName("caret");
	var i;

	for (i = 0; i < toggler.length; i++) {
	  toggler[i].addEventListener("click", function() {
		this.parentElement.querySelector(".nested").classList.toggle("active");
		this.classList.toggle("caret-down");
	  });
	} */	
	
	$('.caret').click(function () {

		$(this).siblings('.nested').toggleClass('active');
		$(this).toggleClass('caret-down');
		
		var w_id = $(this).attr('id');
		
		if (w_id === undefined || w_id.length === 0) return;
			
		var w_estado = fnc_fundacao_obtem_objeto_tela(p_identificacao_tela, 'arvore', {});
			
		w_estado['arvore'][$(this).attr('id')] = $(this).hasClass('caret-down');
			
		fnc_fundacao_salva_objeto_tela(p_identificacao_tela, w_estado);
	});
	
}

function fnc_fundacao_arvore_recupera_estado(p_identificacao_tela) {

	var w_estado = fnc_fundacao_obtem_objeto_tela(p_identificacao_tela, 'arvore', {});

	$('.caret').each(function () {
		
		var w_id = $(this).attr('id');
		
		if (w_id === undefined || w_id.length === 0 || w_estado['arvore'][w_id] === undefined) return;
		
		if (w_estado['arvore'][w_id]) {
			$(this).click();
		}
	});	
}

function fnc_fundacao_sobreposicao_inicia(p_url) {
	
	if (p_url.startsWith('http://')) {
	
		fnc_fundacao_exibeErroModal('O link precisa ser seguro (https)');
		return;
	}
	
	$('#hot_sobreposto_carregando').show();
	$('#hot_sobreposto_conteudo').html($('<iframe>', { 'src': p_url.startsWith('https://') ? p_url : `https://${p_url}`, 'width': '100%', 'height': '100%' }).on('load', function() { console.log('Iframe loaded'); $('#hot_sobreposto_carregando').attr('style', 'display: none !important'); }));
	$('#hot_sobreposto').show();
}

function fnc_fundacao_imgError(image, imageReplacement) {
    image.onerror = null;
    image.src = imageReplacement;
    return true;
}

function fnc_fundacao_alerta_suspensao_parametros(p_status, p_perfil, p_data, p_mensagem) {
	
	var w_imediato = p_perfil !== sessionStorage.getItem("hot-alerta-suspensao-perfil");
		
	sessionStorage.setItem("hot-alerta-suspensao-status", p_status);
	sessionStorage.setItem("hot-alerta-suspensao-perfil", p_perfil);
	sessionStorage.setItem("hot-alerta-suspensao-data", p_data);
	sessionStorage.setItem("hot-alerta-suspensao-mensagem", p_mensagem);
	
	if (w_imediato) {
					
		sessionStorage.setItem("hot-alerta-suspensao-contador", 1000);
		
		fnc_fundacao_alerta_suspensao();		
	}	
}

function fnc_fundacao_alerta_suspensao() {
	
	if (sessionStorage.getItem("hot-alerta-suspensao-status") !== 'P') return;

	var w_contador = sessionStorage.getItem("hot-alerta-suspensao-contador");
	
	w_contador = w_contador === undefined || w_contador === null || isNaN(w_contador) ? 1000 : parseInt(w_contador);
	
	if (w_contador++ > 30) {
		
		var w_mensagem = sessionStorage.getItem("hot-alerta-suspensao-mensagem");
		
		w_mensagem = w_mensagem === undefined || w_mensagem === null || w_mensagem.length === 0 ? '<p>Caro cliente,</p><p>gentileza contatar o suporte financeiro do Eduno, pelo e-mail <b>jeane.baptista@hotsystems.com.br</b> ou pelo WhatsApp <b>(31) 98773-9143</b>. Obrigado!</p>' : w_mensagem;
		
		fnc_toaster('E', 'ATENÇÃO!', `${w_mensagem}<p>Esta conta será bloqueada em ${sessionStorage.getItem("hot-alerta-suspensao-data")}.</p>`, 20000);
		
		w_contador = 0;
	}
	
	sessionStorage.setItem("hot-alerta-suspensao-contador", w_contador);
	
}

function fnc_fundacao_direciona1Parm(p_idBotao) {

	$(`#${p_idBotao}`).click(function () {
		
		var w_array = [];	
	
		w_array.push({ "id": "parm", "valor": $(this).attr('data-parm') });
				
		fnc_fundacao_enviaTelaParaServidor($(this).attr('data-link'), 
			w_array, 
			function(p_url, p_retorno) { location.href = p_url; }, 
			$(this).attr('data-redirect'), 
			function() {
				$('#remocaoModalErro').text(w_obj.msg);
				$('#remocaoModalErro').show();
			});		
	});
}

function fnc_fundacao_formataCPFouCNPJ(p_idBotao) {
	
	$(`#${p_idBotao}`).keypress(function (e) {
		
		e.preventDefault();

		var w_input = $(this).val().replace(/[^0-9]/g, '');
		
		w_input = w_input + (w_input.length === 14 || isNaN(e.key) ? '' : e.key);
		
		$(this).val(w_input.length <= 11
			? w_input.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/g, "\$1.\$2.\$3-\$4")
			: w_input.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/g, "\$1.\$2.\$3/\$4-\$5"));
		
/* 		if (e.which < 48 || e.which > 57) {
			e.preventDefault();
		} */
	});	
	
}

function fnc_fundacao_tabela_navegacao(p_offset, p_link) {

	$('.bt-posicao').click(function () {
			
		var w_posicao = p_offset;
		
		switch ($(this).attr('data-pos')) {
			case '0':
				w_posicao = 0;
				break;
			case '-':
				w_posicao = w_posicao < 10 ? 0 : w_posicao - 10;
				break;
			case '+':
				w_posicao = w_posicao + 10;
				break;
			case '99':
				w_posicao = 999999999;
				break;
		}
		
		location.href = `${p_link}/${w_posicao}`;
		
	});
}

function fnc_fundacao_transformaMaiusculas(p_array) {

	p_array.forEach(function (p_elemento) {

		$(`#${p_elemento}`).keyup(function () {
			$(this).val($(this).val().toUpperCase());
		});
	});
}

function fnc_fundacao_transformaMinusculas(p_array) {

	p_array.forEach(function (p_elemento) {

		$(`#${p_elemento}`).keyup(function () {
			$(this).val($(this).val().toLowerCase());
		});
	});
}

function fnc_fundacao_abreConversaWhatsapp(p_celular, p_mensagem) {
			
	window.open('https://wa.me/55' + p_celular + '?text=' + encodeURIComponent(p_mensagem));	
}

function fnc_fundacao_exibeEscondeCampos(p_select) {
	
	p_select.change(function () {
		fnc_fundacao_exibeEscondeCamposCallBack($(this));
	});
	
	fnc_fundacao_exibeEscondeCamposCallBack(p_select);
}

function fnc_fundacao_exibeEscondeCamposCallBack(p_select) {
	
	var w_campos = p_select.attr('data-campos');
	w_campos = w_campos === undefined ? [] : w_campos.split(',');
	
	w_campos.forEach(function (p_elemento) {
		$(p_elemento).addClass('d-none');
	});
	
	var w_campos = p_select.find('option:selected').attr('data-campos');
	w_campos = w_campos === undefined ? [] : w_campos.split(',');
	
	w_campos.forEach(function (p_elemento) {
		$(p_elemento).removeClass('d-none');
	});
}

function fnc_fundacao_formatarEmReal(p_numero) {
	return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(p_numero);
}

function fnc_fundacao_formatarComoDecimal(p_numero) {
	return new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(p_numero);
}

function fnc_fundacao_habilitar_copiarAreaTransferencia() {

	$('.hot-copiar-area-transf').click(function() {

		var w_input = $(this).attr('data-input');
		var w_div = $(this).attr('data-div');

		var w_conteudo = w_input !== undefined ? $(`#${w_input}`).val() : (w_div !== undefined ? $(`#${w_div}`).text() : "");
		var w_botao = $(this);

		navigator.clipboard.writeText(w_conteudo)
            .then(() => {
            	w_botao.addClass('clicado');
            }).catch(err => {
                console.error("Erro ao copiar texto: ", err);
            });
	});
}

function fnc_fundacao_habilitar_abrirLink() {

	$('.hot-abrir-link').click(function() {

		var w_input = $(this).attr('data-input');
		var w_div = $(this).attr('data-div');

		var w_conteudo = w_input !== undefined ? $(`#${w_input}`).val() : (w_div !== undefined ? $(`#${w_div}`).text() : "");
		
		$(this).addClass('clicado');

		if (w_conteudo.length > 0) {
			window.open(w_conteudo, '_blank');
		}
	});
}